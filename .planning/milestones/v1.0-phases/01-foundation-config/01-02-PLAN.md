---
phase: 01-foundation-config
plan: 02
type: tdd
wave: 1
depends_on: [01-01]
files_modified:
  - src/protocol/mod.rs
  - src/protocol/jsonrpc.rs
  - src/protocol/id_remapper.rs
  - src/lib.rs
  - tests/id_remap_test.rs
autonomous: true
requirements: [PROTO-01, PROTO-04]

must_haves:
  truths:
    - "JSON-RPC 2.0 requests with string, number, or null IDs deserialize correctly"
    - "JSON-RPC 2.0 responses serialize with correct structure (result XOR error, never both)"
    - "Notifications (no id field) are distinguished from requests"
    - "ID remapping produces unique gateway IDs across concurrent backends"
    - "ID restore returns the original client ID and backend name"
    - "Restoring an ID removes it from the pending map (no memory leak)"
  artifacts:
    - path: "src/protocol/jsonrpc.rs"
      provides: "JSON-RPC 2.0 types: JsonRpcId, JsonRpcRequest, JsonRpcResponse, JsonRpcError, error code constants"
      contains: "JsonRpcId"
      min_lines: 40
    - path: "src/protocol/id_remapper.rs"
      provides: "IdRemapper with AtomicU64 counter and Mutex<HashMap> for request ID remapping"
      contains: "IdRemapper"
      min_lines: 30
    - path: "tests/id_remap_test.rs"
      provides: "Unit and concurrency tests for ID remapping"
      min_lines: 60
  key_links:
    - from: "src/protocol/id_remapper.rs"
      to: "src/protocol/jsonrpc.rs"
      via: "uses JsonRpcId type"
      pattern: "use.*JsonRpcId"
    - from: "src/lib.rs"
      to: "src/protocol/mod.rs"
      via: "module declaration"
      pattern: "pub mod protocol"
---

<objective>
Implement JSON-RPC 2.0 types and request ID remapping with test-first development. These are the foundational protocol types that every subsequent phase builds on.

Purpose: Own the JSON-RPC types (not using jsonrpc-core or rmcp) for maximum control over serialization and ID handling. Prove ID remapping correctness with concurrent tests.
Output: Tested JSON-RPC types and ID remapper module.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-config/1-RESEARCH.md
@.planning/phases/01-foundation-config/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: JSON-RPC 2.0 types and ID remapper (TDD)</name>
  <files>
    src/protocol/mod.rs
    src/protocol/jsonrpc.rs
    src/protocol/id_remapper.rs
    src/lib.rs
    tests/id_remap_test.rs
  </files>
  <action>
    Follow RED-GREEN-REFACTOR cycle.

    **RED phase -- write failing tests first:**

    Create tests/id_remap_test.rs with these tests:

    JSON-RPC type tests:
    1. **deserialize_request_with_number_id**: Parse JSON with numeric id, assert JsonRpcId::Number(1).
    2. **deserialize_request_with_string_id**: Parse JSON with string id "abc-123", assert JsonRpcId::String("abc-123").
    3. **deserialize_notification_has_no_id**: Parse JSON without id field, assert id is None and is_notification() is true.
    4. **serialize_response_with_result**: Create JsonRpcResponse with result, serialize to JSON, verify "result" present and "error" absent.
    5. **serialize_response_with_error**: Create JsonRpcResponse with error, serialize, verify "error" present and "result" absent.
    6. **error_codes_match_spec**: Assert PARSE_ERROR == -32700, INVALID_REQUEST == -32600, METHOD_NOT_FOUND == -32601, INVALID_PARAMS == -32602, INTERNAL_ERROR == -32603.

    ID remapper tests:
    7. **remap_produces_unique_ids**: Remap same client ID to two different backends, assert gateway IDs are different.
    8. **restore_returns_original_id**: Remap an ID, restore it, assert original ID and backend name match.
    9. **restore_removes_mapping**: Remap, check pending_count is 1, restore, check pending_count is 0, second restore returns None.
    10. **concurrent_remapping_no_collision**: Spawn 10 threads, each remapping 100 requests. Collect all 1000 gateway IDs. Assert all unique (use HashSet).
    11. **counter_starts_at_one**: First remap returns gateway ID 1, not 0.

    Run `cargo test --test id_remap_test` -- all tests must FAIL (types don't exist yet).
    Commit: "test(01-02): add failing tests for JSON-RPC types and ID remapper"

    **GREEN phase -- implement to pass tests:**

    Create src/protocol/mod.rs with re-exports for jsonrpc and id_remapper modules.

    Create src/protocol/jsonrpc.rs with:
    - JsonRpcId enum: #[serde(untagged)] with Number(u64), String(String), Null variants. Derive Debug, Clone, PartialEq, Eq, Hash, Serialize, Deserialize.
    - JsonRpcRequest struct: jsonrpc String, id Option<JsonRpcId>, method String, params Option<serde_json::Value>. Derive Debug, Clone, Deserialize. Add is_notification() method.
    - JsonRpcResponse struct: jsonrpc String, id JsonRpcId, result Option<Value>, error Option<JsonRpcError>. Use #[serde(skip_serializing_if = "Option::is_none")] on result and error. Derive Debug, Clone, Serialize.
    - JsonRpcError struct: code i32, message String, data Option<Value>. Derive Debug, Clone, Serialize, Deserialize.
    - Error code constants: PARSE_ERROR, INVALID_REQUEST, METHOD_NOT_FOUND, INVALID_PARAMS, INTERNAL_ERROR.
    - Helper: JsonRpcResponse::success(id, result) and JsonRpcResponse::error(id, code, message) constructors.

    Create src/protocol/id_remapper.rs with:
    - IdRemapper struct: counter AtomicU64 (starting at 1), mappings Mutex<HashMap<u64, (JsonRpcId, String)>>.
    - new(): counter starts at 1.
    - remap(original_id: JsonRpcId, backend: &str) -> u64: fetch_add(1, Relaxed), insert mapping, return gateway ID.
    - restore(gateway_id: u64) -> Option<(JsonRpcId, String)>: remove and return mapping.
    - pending_count() -> usize: map length.

    Update src/lib.rs to include `pub mod protocol;`

    Run `cargo test --test id_remap_test` -- all tests must PASS.
    Commit: "feat(01-02): implement JSON-RPC 2.0 types and ID remapper"

    **REFACTOR phase (if needed):**
    Review code for clarity. Ensure no clippy warnings. Run `cargo clippy -- -D warnings`.
    If changes made, commit: "refactor(01-02): clean up JSON-RPC types"

    IMPORTANT: Rust builds require dangerouslyDisableSandbox: true.
  </action>
  <verify>
    Run `cargo test` (all tests including config_test and id_remap_test) -- all pass.
    Run `cargo clippy -- -D warnings` -- no warnings.
    Run `cargo build --release` -- succeeds with 0 warnings.
  </verify>
  <done>
    11 tests pass covering JSON-RPC type serialization/deserialization, notification detection, error codes, ID remapping uniqueness, restore correctness, memory cleanup, and concurrent safety. cargo clippy clean. cargo build --release clean.
  </done>
</task>

</tasks>

<verification>
1. `cargo test` passes all tests (config + JSON-RPC + ID remapper)
2. `cargo clippy -- -D warnings` produces no warnings
3. `cargo build --release` produces binary with 0 errors, 0 warnings
4. JSON-RPC IDs handle string, number, and null variants
5. ID remapper produces unique IDs across 10 concurrent threads with 100 requests each
6. Restored IDs match originals exactly
</verification>

<success_criteria>
- 11+ tests pass for JSON-RPC types and ID remapping
- Concurrent ID generation proven collision-free
- All JSON-RPC 2.0 spec requirements met (polymorphic IDs, notifications, error codes)
- Zero clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-config/01-02-SUMMARY.md`
</output>
