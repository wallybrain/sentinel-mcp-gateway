---
phase: 09-observability-hot-reload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/metrics/mod.rs
  - src/health/server.rs
  - src/lib.rs
  - Cargo.toml
autonomous: true
requirements: [OBS-01, OBS-02]

must_haves:
  truths:
    - "GET /metrics returns Prometheus-compatible text with sentinel_* metric families"
    - "Metrics struct exposes CounterVec for requests, errors, rate limit hits and HistogramVec for latency and GaugeVec for backend health"
    - "All metric recording methods are callable from non-async contexts (metrics objects are Clone + Send + Sync)"
  artifacts:
    - path: "src/metrics/mod.rs"
      provides: "Metrics struct with Prometheus registry, metric definitions, gather_text()"
      exports: ["Metrics"]
    - path: "src/health/server.rs"
      provides: "/metrics route added to existing health router"
      contains: "metrics"
  key_links:
    - from: "src/health/server.rs"
      to: "src/metrics/mod.rs"
      via: "Arc<Metrics> in axum State"
      pattern: "State.*Metrics"
---

<objective>
Create Prometheus metrics module and expose /metrics endpoint on the existing health server.

Purpose: Operational visibility -- request counts, latency histograms, error rates, backend health, and rate limit hits are essential for monitoring the gateway in production.
Output: `src/metrics/mod.rs` with all metric definitions and a `/metrics` route on the health server (port 9201).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-observability-hot-reload/9-RESEARCH.md
@src/health/server.rs
@src/lib.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Metrics module with Prometheus registry and metric definitions</name>
  <files>src/metrics/mod.rs, src/lib.rs, Cargo.toml</files>
  <action>
Add `prometheus = "0.14.0"` to Cargo.toml dependencies.

Create `src/metrics/mod.rs` with a `Metrics` struct containing:
- `requests_total: CounterVec` -- labels: `["tool", "status"]` where status is bounded enum: success, error, killed, rate_limited, denied, circuit_open, invalid_args
- `request_duration_seconds: HistogramVec` -- labels: `["tool"]`, use default histogram buckets
- `errors_total: CounterVec` -- labels: `["tool", "error_type"]` where error_type matches status enum above
- `backend_healthy: GaugeVec` -- labels: `["backend"]`
- `rate_limit_hits_total: CounterVec` -- labels: `["tool"]`
- `registry: prometheus::Registry` (explicit registry, NOT default_registry -- testability)

All metrics use `sentinel_` prefix in their names (e.g., `sentinel_requests_total`).

Implement:
- `Metrics::new() -> Self` -- creates registry, registers all metrics, returns struct
- `Metrics::gather_text() -> String` -- uses `prometheus::TextEncoder` to encode all metrics into Prometheus text format with Content-Type `text/plain; version=0.0.4; charset=utf-8`
- `Metrics::record_request(tool: &str, status: &str, duration_secs: f64)` -- increments requests_total, observes duration, increments errors_total if status != "success"
- `Metrics::record_rate_limit_hit(tool: &str)` -- increments rate_limit_hits_total
- `Metrics::set_backend_health(backend: &str, healthy: bool)` -- sets gauge to 1.0 or 0.0

Add `pub mod metrics;` to `src/lib.rs`.

Unit tests in the same file:
- `test_metrics_new_creates_all_metrics` -- verifies gather_text() contains all 5 metric family names
- `test_record_request_increments_counter` -- records a request, verifies counter value > 0 in gathered text
- `test_record_rate_limit_hit` -- records a hit, verifies in gathered text
- `test_set_backend_health` -- sets healthy/unhealthy, verifies gauge values
  </action>
  <verify>Run `cargo test --lib metrics` -- all 4 tests pass. Run `cargo build` -- no warnings.</verify>
  <done>Metrics struct exists with 5 metric types, all registered to an explicit registry, with recording helper methods and passing unit tests.</done>
</task>

<task type="auto">
  <name>Task 2: Add /metrics endpoint to health server</name>
  <files>src/health/server.rs</files>
  <action>
Modify `build_health_router` to accept an `Option<Arc<Metrics>>` parameter alongside the existing `BackendHealthMap`.

Create a new combined app state struct (or use axum's nested state) that holds both `BackendHealthMap` and `Option<Arc<Metrics>>`. The simplest approach: create a `HealthAppState` struct with both fields, derive Clone, use it as the axum State.

Add a `/metrics` route handler:
```
async fn metrics_handler(State(state): State<HealthAppState>) -> impl IntoResponse {
    match &state.metrics {
        Some(m) => (
            StatusCode::OK,
            [(header::CONTENT_TYPE, "text/plain; version=0.0.4; charset=utf-8")],
            m.gather_text(),
        ),
        None => (
            StatusCode::NOT_FOUND,
            [(header::CONTENT_TYPE, "text/plain; charset=utf-8")],
            "Metrics not enabled".to_string(),
        ),
    }
}
```

Update `run_health_server` signature to accept `Option<Arc<Metrics>>` and pass it through to `build_health_router`.

Update existing `liveness` and `readiness` handlers to use the new `HealthAppState` (extract `health_map` from it).

Update all existing tests to pass `None` for metrics (backwards compatible). Add new tests:
- `test_metrics_endpoint_returns_prometheus_text` -- create Metrics, record a request, verify /metrics returns 200 with sentinel_ content
- `test_metrics_endpoint_returns_404_when_disabled` -- pass None, verify /metrics returns 404

IMPORTANT: Do not change main.rs yet -- pass `None` for metrics in main.rs for now. Plan 03 will wire the real Metrics into main.rs.
  </action>
  <verify>Run `cargo test --lib health` -- all existing + 2 new tests pass. Run `cargo build` -- no warnings.</verify>
  <done>/metrics endpoint exists on health server, returns Prometheus text format when metrics are provided, 404 when None. All existing health tests still pass.</done>
</task>

</tasks>

<verification>
- `cargo test --lib metrics` passes all tests
- `cargo test --lib health` passes all tests (existing + new)
- `cargo build` compiles without warnings
- `grep -r "sentinel_requests_total" src/metrics/` confirms metric naming
</verification>

<success_criteria>
- Metrics module exists with 5 Prometheus metric types (CounterVec, HistogramVec, GaugeVec)
- /metrics endpoint added to health server router
- All recording helper methods are tested
- Backward compatible (main.rs unchanged, passes None for metrics)
</success_criteria>

<output>
After completion, create `.planning/phases/09-observability-hot-reload/09-01-SUMMARY.md`
</output>
