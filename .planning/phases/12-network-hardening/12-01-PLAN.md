---
phase: 12-network-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/lwb3/v1be-code-server/fix-iptables.sh
autonomous: true
requirements:
  - NET-01
  - NET-02
  - NET-03
  - NET-04

must_haves:
  truths:
    - "Ports 9200 and 9201 are unreachable from the public internet"
    - "iptables DROP rules block eth0 traffic to ports 9200 and 9201"
    - "fix-iptables.sh produces correct firewall state when re-run"
    - "Stale ContextForge Docker network is removed"
  artifacts:
    - path: "/home/lwb3/v1be-code-server/fix-iptables.sh"
      provides: "iptables rules including Sentinel port DROP rules"
      contains: "9200"
  key_links:
    - from: "fix-iptables.sh"
      to: "iptables INPUT chain"
      via: "privileged Docker container execution"
      pattern: "iptables.*9200.*DROP"
---

<objective>
Harden Sentinel Gateway network by adding defensive iptables DROP rules for ports 9200/9201, updating fix-iptables.sh for reboot persistence, and cleaning up the stale ContextForge Docker network.

Purpose: Defense-in-depth firewall rules ensure Sentinel ports stay unreachable from the public internet even if binding configuration changes in the future. Stale network cleanup removes ContextForge artifacts.
Output: Updated fix-iptables.sh, active iptables rules, removed stale network.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-network-hardening/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify port binding and add iptables DROP rules for Sentinel ports</name>
  <files>/home/lwb3/v1be-code-server/fix-iptables.sh</files>
  <action>
    First, verify current port binding state (NET-01):
    - Run `ss -tlnp | grep -E '9200|9201'` to confirm port 9200 is not listening and port 9201 is bound to 127.0.0.1
    - This is verification only -- no changes needed for NET-01

    Then update fix-iptables.sh (NET-02, NET-03):
    - Add two new DROP rules for Sentinel ports after the existing eth0 DROP rules, following the identical idempotent pattern:
      ```
      iptables -C INPUT -i eth0 -p tcp --dport 9200 -j DROP 2>/dev/null || \
      iptables -A INPUT -i eth0 -p tcp --dport 9200 -j DROP && \
      echo 'DROP eth0 -> port 9200 (sentinel-gateway MCP)' && \
      \
      iptables -C INPUT -i eth0 -p tcp --dport 9201 -j DROP 2>/dev/null || \
      iptables -A INPUT -i eth0 -p tcp --dport 9201 -j DROP && \
      echo 'DROP eth0 -> port 9201 (sentinel-gateway health)'
      ```
    - Update the comment header to include Sentinel ports in the description
    - IMPORTANT: Use the privileged Docker container pattern (`docker run --rm --privileged --net=host ubuntu:24.04`) -- `sudo` is unavailable on this VPS

    Then execute fix-iptables.sh to apply rules immediately:
    - Run the updated script
    - Verify all rules are active by dumping iptables from a privileged container: `docker run --rm --privileged --net=host ubuntu:24.04 bash -c "apt-get update -qq && apt-get install -y -qq iptables > /dev/null 2>&1 && iptables -S INPUT | grep -E '9200|9201'"`
  </action>
  <verify>
    1. `ss -tlnp | grep 9200` shows no listener (or 127.0.0.1 only)
    2. `ss -tlnp | grep 9201` shows 127.0.0.1:9201
    3. iptables dump from privileged container shows DROP rules for both 9200 and 9201 on eth0
    4. fix-iptables.sh contains the new rules (grep confirms)
  </verify>
  <done>Port 9200 is not publicly listening, port 9201 is bound to 127.0.0.1, iptables DROP rules block both ports on eth0, fix-iptables.sh is updated for reboot persistence</done>
</task>

<task type="auto">
  <name>Task 2: Remove stale ContextForge Docker network</name>
  <files></files>
  <action>
    Clean up the stale ContextForge network (NET-04):
    - Verify all ContextForge containers are stopped: `docker ps --filter name=mcp-context-forge --format '{{.Names}} {{.Status}}'`
    - Remove the stale network: `docker network rm mcp-context-forge_mcpnet`
    - Verify removal: `docker network ls | grep mcpnet`
    - Verify the active Sentinel network is untouched: `docker network ls | grep sentinelnet`

    Do NOT remove ContextForge containers or images (that is DECOM-01, deferred to v1.2+).
  </action>
  <verify>
    1. `docker network ls | grep mcp-context-forge` returns nothing
    2. `docker network ls | grep sentinelnet` still shows the active Sentinel network
    3. Sentinel health endpoint still responds: `curl -s http://127.0.0.1:9201/health`
  </verify>
  <done>Stale mcp-context-forge_mcpnet Docker network is removed, Sentinel network and containers are unaffected</done>
</task>

</tasks>

<verification>
Run all checks in sequence:
1. `ss -tlnp | grep -E '9200|9201'` -- 9200 not listening, 9201 on 127.0.0.1
2. iptables dump via privileged container confirms DROP rules for 9200 and 9201 on eth0
3. `docker network ls | grep mcpnet` -- no ContextForge network
4. `docker network ls | grep sentinelnet` -- Sentinel network still active
5. `curl -s http://127.0.0.1:9201/health` -- Sentinel health returns 200
6. `grep 9200 /home/lwb3/v1be-code-server/fix-iptables.sh` -- rules present in script
</verification>

<success_criteria>
- NET-01: Verified -- ports bound to 127.0.0.1 only (or not listening)
- NET-02: iptables DROP rules active for 9200 and 9201 on eth0
- NET-03: fix-iptables.sh contains Sentinel rules and produces correct state on re-run
- NET-04: mcp-context-forge_mcpnet network removed
</success_criteria>

<output>
After completion, create `.planning/phases/12-network-hardening/12-01-SUMMARY.md`
</output>
