---
phase: 11-cutover-execution
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified: []
autonomous: false
requirements: [CUT-01, CUT-02, CUT-03, CUT-04, CUT-05]

must_haves:
  truths:
    - "ContextForge gateway container is stopped (not removed — images and volumes preserved for rollback)"
    - "Claude Code MCP config updated to spawn native Sentinel binary with correct env vars"
    - "Sentinel responds to MCP tool calls via stdio and health/metrics on port 9201"
    - "All governed backends respond to tool calls through Sentinel (n8n and sqlite via HTTP sidecars)"
    - "Rollback procedure is documented and tested (can restart ContextForge within 60 seconds)"
  artifacts: []
  key_links:
    - from: "~/.claude/settings.json"
      to: "target/release/sentinel-gateway"
      via: "MCP server command"
      pattern: "sentinel-gateway.*--config"
    - from: "sentinel.toml"
      to: "docker containers (mcp-n8n, mcp-sqlite)"
      via: "HTTP backend URLs on localhost"
      pattern: "http://127.0.0.1:300[12]"
---

<objective>
Execute the actual cutover: stop ContextForge, update Claude Code MCP config to spawn
the native Sentinel binary, verify all backends work end-to-end, and document rollback.

Purpose: After this plan, Sentinel is the live MCP gateway and ContextForge is stopped.

Output: Sentinel serving all MCP traffic. ContextForge stopped but available for rollback.
</objective>

<execution_context>
@.planning/phases/11-cutover-execution/11-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cutover-execution/11-01-SUMMARY.md
@sentinel.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stop ContextForge and verify port release</name>
  <files></files>
  <action>
  Stop the ContextForge gateway. Use `stop` not `down` — preserve containers and volumes.

  ```bash
  docker compose -f /home/lwb3/mcp-context-forge/docker-compose.yml stop
  ```

  Verify port 9200 is released:
  ```bash
  curl -sf http://127.0.0.1:9200/health && echo "STILL RUNNING" || echo "STOPPED"
  ```

  Verify containers are stopped (not removed):
  ```bash
  docker ps -a --filter name=mcp-context-forge --format "{{.Names}} {{.Status}}"
  ```
  Should show "Exited" status.

  **CUT-01 satisfied.**
  </action>
  <verify>
  - `curl -sf http://127.0.0.1:9200/health` fails (port released)
  - `docker ps -a --filter name=mcp-context-forge` shows stopped containers
  </verify>
  <done>ContextForge stopped. Port 9200 released. Containers preserved for rollback.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Update Claude Code MCP config and restart</name>
  <files></files>
  <action>
  **User must update ~/.claude/settings.json manually** (contains secrets).

  Replace the current `sentinel-gateway` MCP server entry with:

  ```json
  "sentinel-gateway": {
    "command": "/home/lwb3/sentinel-gateway/target/release/sentinel-gateway",
    "args": ["--config", "/home/lwb3/sentinel-gateway/sentinel.toml"],
    "env": {
      "JWT_SECRET_KEY": "<from /home/lwb3/sentinel-gateway/.env>",
      "SENTINEL_TOKEN": "<from /tmp/claude-1001/sentinel-token.txt>",
      "DATABASE_URL": "postgres://sentinel:<POSTGRES_PASSWORD from .env>@127.0.0.1:5432/sentinel"
    }
  }
  ```

  Steps:
  1. Read JWT_SECRET_KEY from `.env`
  2. Read SENTINEL_TOKEN from `/tmp/claude-1001/sentinel-token.txt`
  3. Read POSTGRES_PASSWORD from `.env`
  4. Update `~/.claude/settings.json`
  5. Restart Claude Code to pick up the new MCP config

  Resume signal: Type "config updated" after restarting Claude Code.

  **CUT-03 satisfied.**
  </action>
  <verify>User confirms config updated and Claude Code restarted.</verify>
  <done>Claude Code MCP config updated to spawn native Sentinel binary.</done>
</task>

<task type="auto">
  <name>Task 3: Verify Sentinel health, backends, and document rollback</name>
  <files></files>
  <action>
  **Health verification (CUT-02):**
  ```bash
  curl -sf http://127.0.0.1:9201/health | jq .
  curl -sf http://127.0.0.1:9201/metrics | head -10
  pgrep -a sentinel-gateway
  ```

  **Backend verification (CUT-04):**
  Call at least one tool from each governed backend:
  1. **sqlite**: `mcp__sentinel-gateway__sqlite_databases` — should list databases
  2. **n8n**: `mcp__sentinel-gateway__list_workflows` — should list workflows

  If stdio backends are configured (context7, firecrawl, etc.), test them too.
  Stdio backends may fail if npm paths are wrong — this is acceptable for now
  since they run as separate MCP servers in Claude Code anyway.

  **Rollback documentation (CUT-05):**
  Document rollback steps:
  1. Stop Sentinel: close Claude Code (or `pkill sentinel-gateway`)
  2. Restart ContextForge: `docker compose -f /home/lwb3/mcp-context-forge/docker-compose.yml start`
  3. Revert `~/.claude/settings.json` to original ContextForge wrapper command
  4. Restart Claude Code

  Test rollback is possible:
  ```bash
  docker ps -a --filter name=mcp-context-forge --format "{{.Names}}"
  ```
  Containers must still exist.
  </action>
  <verify>
  - `curl -sf http://127.0.0.1:9201/health` returns 200
  - `pgrep sentinel-gateway` finds the process
  - sqlite MCP tool call returns data
  - n8n MCP tool call returns data
  - ContextForge containers exist for rollback
  </verify>
  <done>Sentinel running natively. All governed backends verified. Rollback documented.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Final user approval</name>
  <files></files>
  <action>
  Present cutover status:
  - [ ] ContextForge stopped (CUT-01)
  - [ ] Sentinel health responding on 9201 (CUT-02)
  - [ ] Claude Code config updated (CUT-03)
  - [ ] n8n + sqlite tool calls work (CUT-04)
  - [ ] Rollback documented and tested (CUT-05)

  Resume signal: "approved" if satisfied.
  </action>
  <verify>User confirms all 5 requirements satisfied.</verify>
  <done>Phase 11 cutover complete. Sentinel is the live MCP gateway.</done>
</task>

</tasks>

<verification>
1. `docker ps -a --filter name=mcp-context-forge` -- containers stopped (not removed)
2. `curl -sf http://127.0.0.1:9201/health` -- Sentinel health responding
3. `pgrep sentinel-gateway` -- process running
4. MCP tool call to sqlite succeeds
5. MCP tool call to n8n succeeds
6. ContextForge containers can be restarted (rollback viable)
</verification>

<success_criteria>
- ContextForge stopped, containers preserved for rollback
- Sentinel running natively, health on 9201
- Claude Code MCP config spawns Sentinel binary with correct env vars
- n8n and sqlite tool calls work end-to-end through Sentinel
- Rollback procedure documented and tested
- User has approved the cutover
</success_criteria>

<output>
After completion, create `.planning/phases/11-cutover-execution/11-02-SUMMARY.md`
</output>
