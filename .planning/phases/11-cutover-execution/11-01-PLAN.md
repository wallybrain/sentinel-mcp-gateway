---
phase: 11-cutover-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - sentinel.toml
autonomous: true
requirements: [CUT-02, CUT-03]

must_haves:
  truths:
    - "Sentinel release binary exists at target/release/sentinel-gateway and runs successfully"
    - "Docker sidecars (mcp-n8n, mcp-sqlite) and postgres expose host ports reachable from localhost"
    - "sentinel.toml backend URLs point to localhost ports matching the Docker port mappings"
    - "DATABASE_URL with localhost:5432 can reach sentinel-postgres container"
    - "A valid JWT token exists for the native Sentinel deployment"
  artifacts:
    - path: "target/release/sentinel-gateway"
      provides: "Native Sentinel binary"
    - path: "sentinel.toml"
      provides: "Config with localhost backend URLs and 127.0.0.1 binding for health"
    - path: "docker-compose.yml"
      provides: "Updated compose without gateway service, with sidecar port exposure"
  key_links:
    - from: "sentinel.toml"
      to: "docker-compose.yml"
      via: "Backend URLs match exposed ports"
      pattern: "http://127.0.0.1:300[12]"
    - from: "sentinel.toml"
      to: "docker-compose.yml"
      via: "DATABASE_URL postgres port"
      pattern: "127.0.0.1:5432"
---

<objective>
Prepare for native binary deployment: build the release binary, reconfigure Docker compose
to expose sidecar and postgres ports to localhost, update sentinel.toml with localhost URLs,
generate a JWT token, and restart sidecars with new port mappings.

Purpose: The native binary runs on the host (spawned by Claude Code via stdio), not in Docker.
It needs to reach the sidecar containers and postgres via localhost ports. The Docker
gateway container is no longer needed.

Output: Built binary, updated docker-compose.yml and sentinel.toml, generated JWT token,
sidecars running with localhost port exposure.
</objective>

<execution_context>
@.planning/phases/11-cutover-execution/11-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-pre-cutover-preparation/10-02-SUMMARY.md
@docker-compose.yml
@sentinel.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Sentinel release binary</name>
  <files></files>
  <action>
  Build the release binary. Requires `dangerouslyDisableSandbox: true`.

  ```bash
  cd /home/lwb3/sentinel-gateway
  cargo build --release
  ```

  This produces `target/release/sentinel-gateway`. Verify it runs:
  ```bash
  ./target/release/sentinel-gateway --help
  ```

  Should print usage info without errors.
  </action>
  <verify>
  - `test -f target/release/sentinel-gateway && echo OK` returns OK
  - `./target/release/sentinel-gateway --help` exits with code 0
  </verify>
  <done>Release binary built and verified at target/release/sentinel-gateway.</done>
</task>

<task type="auto">
  <name>Task 2: Update docker-compose.yml and sentinel.toml, generate JWT token</name>
  <files>
    docker-compose.yml
    sentinel.toml
  </files>
  <action>
  **docker-compose.yml changes:**

  1. **Remove the gateway service entirely** — replaced by native binary.

  2. **Add port mappings to mcp-n8n**: `"127.0.0.1:3001:3000"`

  3. **Add port mappings to mcp-sqlite**: `"127.0.0.1:3002:3000"`

  4. **Add port mapping to postgres**: `"127.0.0.1:5432:5432"`

  5. Keep sentinelnet and n8nnet networks (mcp-n8n still needs n8nnet to reach n8n).

  Final compose: 3 services (postgres, mcp-n8n, mcp-sqlite).

  **sentinel.toml changes:**

  1. Change HTTP backend URLs from Docker hostnames to localhost:
     - n8n: `http://mcp-n8n:3000` → `http://127.0.0.1:3001`
     - sqlite: `http://mcp-sqlite:3000` → `http://127.0.0.1:3002`

  2. Keep `listen = "127.0.0.1:9200"` (not used in stdio mode, but available for future HTTP).

  3. Keep all 7 backends (2 HTTP + 5 stdio) — native binary can spawn Node.js.

  4. **Verify stdio backend paths** exist on filesystem:
     ```bash
     ls /usr/local/lib/node_modules/@upstash/context7-mcp/dist/index.js
     ls /usr/local/lib/node_modules/firecrawl-mcp/dist/index.js
     # etc.
     ```
     If paths are wrong (npx installs to cache, not /usr/local/lib), find the actual
     paths or install globally. Update sentinel.toml paths accordingly.

  **JWT token generation:**

  Generate using PyJWT with the **raw string** JWT_SECRET_KEY (not base64-decoded):
  ```python
  import jwt, time, uuid
  # Extract raw string from .env
  token = jwt.encode({
      'sub': 'admin@wallybrain.net', 'role': 'admin',
      'iss': 'sentinel-gateway', 'aud': 'sentinel-api',
      'jti': str(uuid.uuid4()),
      'iat': int(time.time()), 'exp': int(time.time()) + 365*24*3600
  }, secret_raw_string, algorithm='HS256')
  ```
  Write token to `/tmp/claude-1001/sentinel-token.txt`.
  </action>
  <verify>
  - `docker compose config` succeeds (YAML valid)
  - `grep -c 'gateway' docker-compose.yml` returns 0
  - `grep '3001:3000' docker-compose.yml` shows mcp-n8n port
  - `grep '3002:3000' docker-compose.yml` shows mcp-sqlite port
  - `grep '5432:5432' docker-compose.yml` shows postgres port
  - `grep '127.0.0.1:3001' sentinel.toml` shows n8n URL
  - `grep '127.0.0.1:3002' sentinel.toml` shows sqlite URL
  - `grep -c '\[\[backends\]\]' sentinel.toml` returns 7
  - Token file exists at `/tmp/claude-1001/sentinel-token.txt`
  </verify>
  <done>docker-compose.yml, sentinel.toml, and JWT token all updated for native deployment.</done>
</task>

<task type="auto">
  <name>Task 3: Restart Docker sidecars and verify localhost connectivity</name>
  <files></files>
  <action>
  Apply the updated docker-compose.yml. Requires `dangerouslyDisableSandbox: true`.

  ```bash
  cd /home/lwb3/sentinel-gateway
  docker compose down
  docker compose up -d
  ```

  Wait for containers to become healthy:
  ```bash
  sleep 15 && docker compose ps
  ```

  Verify sidecars are reachable from localhost:
  ```bash
  curl -sf http://127.0.0.1:3001/health  # mcp-n8n
  curl -sf http://127.0.0.1:3002/health  # mcp-sqlite
  ```

  Verify postgres is reachable (use docker exec if psql unavailable):
  ```bash
  docker exec sentinel-postgres pg_isready -U sentinel -d sentinel
  ```
  </action>
  <verify>
  - `docker compose ps` shows 3 services (postgres, mcp-n8n, mcp-sqlite) all healthy
  - `curl -sf http://127.0.0.1:3001/health` returns healthy
  - `curl -sf http://127.0.0.1:3002/health` returns healthy
  - Postgres reachable on localhost:5432
  </verify>
  <done>Docker sidecars and postgres running with localhost port exposure. All reachable from host.</done>
</task>

</tasks>

<verification>
1. `test -f target/release/sentinel-gateway` -- binary exists
2. `docker compose ps` -- 3 services healthy (no gateway)
3. `curl -sf http://127.0.0.1:3001/health` -- mcp-n8n reachable
4. `curl -sf http://127.0.0.1:3002/health` -- mcp-sqlite reachable
5. `grep '127.0.0.1:3001' sentinel.toml` -- config points to localhost
6. `test -f /tmp/claude-1001/sentinel-token.txt` -- token ready
</verification>

<success_criteria>
- Release binary built and executable
- docker-compose.yml has 3 services with port exposure (no gateway)
- sentinel.toml HTTP backends point to localhost:3001 and localhost:3002
- All 7 backends configured in sentinel.toml
- JWT token generated and stored
- Docker sidecars and postgres healthy and reachable from localhost
</success_criteria>

<output>
After completion, create `.planning/phases/11-cutover-execution/11-01-SUMMARY.md`
</output>
