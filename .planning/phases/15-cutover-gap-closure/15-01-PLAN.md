---
phase: 15-cutover-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/lwb3/sentinel-gateway/add-mcp.sh
  - /home/lwb3/sentinel-gateway/sentinel.toml
  - /home/lwb3/sentinel-gateway/sentinel-docker.toml
  - /home/lwb3/sentinel-gateway/.planning/REQUIREMENTS.md
  - ~/.claude.json
autonomous: true
requirements: [CUT-01, CUT-04, CUT-05]
gap_closure: true

must_haves:
  truths:
    - "FIRECRAWL_API_KEY is explicitly wired in add-mcp.sh env block, not relying on inherited process env"
    - "health_listen is explicit in sentinel.toml at 127.0.0.1:9201"
    - "sentinel-docker.toml no longer exists on disk"
    - "Only one sentinel-gateway MCP registration exists in ~/.claude.json (under /home/lwb3 scope)"
    - "REQUIREMENTS.md checkboxes for CUT-01, CUT-04, CUT-05 are updated"
  artifacts:
    - path: "/home/lwb3/sentinel-gateway/add-mcp.sh"
      provides: "Durable Firecrawl API key wiring"
      contains: "FIRECRAWL_API_KEY"
    - path: "/home/lwb3/sentinel-gateway/sentinel.toml"
      provides: "Explicit health listen address"
      contains: "health_listen"
    - path: "/home/lwb3/sentinel-gateway/.planning/REQUIREMENTS.md"
      provides: "Accurate requirement status tracking"
      contains: "[x] **CUT-01**"
  key_links:
    - from: "add-mcp.sh"
      to: ".env"
      via: "sed extraction of FIRECRAWL_API_KEY"
      pattern: "FIRECRAWL_API_KEY"
    - from: "sentinel.toml"
      to: "fix-iptables.sh"
      via: "health_listen port matching iptables rules"
      pattern: "health_listen.*9201"
---

<objective>
Fix all config, wiring, and documentation gaps identified in the v1.1 milestone audit.

Purpose: Close CUT-01/CUT-04/CUT-05 audit gaps that don't require runtime testing — durable env wiring, explicit config, dead file cleanup, duplicate registration removal, and doc sync.
Output: Updated add-mcp.sh, sentinel.toml, REQUIREMENTS.md; removed sentinel-docker.toml and duplicate MCP registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md
@.planning/REQUIREMENTS.md
@sentinel.toml
@add-mcp.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden env wiring and config explicitness</name>
  <files>
    /home/lwb3/sentinel-gateway/add-mcp.sh
    /home/lwb3/sentinel-gateway/sentinel.toml
  </files>
  <action>
1. In `add-mcp.sh`: Add FIRECRAWL_API_KEY extraction from .env using the same sed pattern as the other vars:
   ```
   FIRECRAWL_API_KEY="$(sed -n 's/^FIRECRAWL_API_KEY=//p' /home/lwb3/sentinel-gateway/.env)"
   ```
   Then add it to the env dict in the python3 JSON builder:
   ```python
   'FIRECRAWL_API_KEY': sys.argv[4],
   ```
   And pass it as the 4th positional arg to python3.

2. In `sentinel.toml`: Add `health_listen = "127.0.0.1:9201"` to the `[gateway]` section (after `audit_enabled`). This makes the health endpoint port explicit rather than relying on a hardcoded default in the binary. The value 9201 matches what iptables rules and fix-iptables.sh already target.
  </action>
  <verify>
    - `grep FIRECRAWL_API_KEY /home/lwb3/sentinel-gateway/add-mcp.sh` shows both the sed extraction line and the env dict entry
    - `grep health_listen /home/lwb3/sentinel-gateway/sentinel.toml` shows `health_listen = "127.0.0.1:9201"`
  </verify>
  <done>
    - add-mcp.sh includes FIRECRAWL_API_KEY in its env block (durable wiring, survives Claude Code reinstall)
    - sentinel.toml has explicit health_listen (no silent mismatch if binary default ever changes)
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up orphaned files and duplicate registrations</name>
  <files>
    /home/lwb3/sentinel-gateway/sentinel-docker.toml
    ~/.claude.json
    /home/lwb3/sentinel-gateway/CLAUDE.md
  </files>
  <action>
1. Delete `/home/lwb3/sentinel-gateway/sentinel-docker.toml` — orphaned config from when the gateway ran in Docker (Phase 10). The gateway now runs as a native binary using `sentinel.toml`.

2. Remove the duplicate sentinel-gateway MCP registration from `~/.claude.json`. The file has MCP registrations under two project scopes:
   - `/home/lwb3` (the correct global scope — KEEP this one)
   - `/home/lwb3/sentinel-gateway` (project-specific duplicate — REMOVE this one)
   Use `python3 -c` with json module to read the file, delete the sentinel-gateway key from the `/home/lwb3/sentinel-gateway` project scope's mcpServers (if the scope becomes empty, remove the entire scope entry), and write back.

3. Update `/home/lwb3/sentinel-gateway/CLAUDE.md` Key Paths table: remove the `sentinel-docker.toml` row since the file no longer exists.
  </action>
  <verify>
    - `ls /home/lwb3/sentinel-gateway/sentinel-docker.toml 2>/dev/null` returns nothing (file deleted)
    - `python3 -c "import json; d=json.load(open('/home/lwb3/.claude.json')); print([k for k,v in d.get('projects',{}).items() if 'sentinel-gateway' in v.get('mcpServers',{})])"` returns only `['/home/lwb3']` (no duplicate)
    - `grep sentinel-docker CLAUDE.md` returns nothing
  </verify>
  <done>
    - sentinel-docker.toml is gone (no confusion about which config file is active)
    - Only one sentinel-gateway MCP registration exists (no risk of double-spawn port conflict)
    - CLAUDE.md no longer references the dead config file
  </done>
</task>

<task type="auto">
  <name>Task 3: Update REQUIREMENTS.md checkboxes and text</name>
  <files>
    /home/lwb3/sentinel-gateway/.planning/REQUIREMENTS.md
  </files>
  <action>
Update REQUIREMENTS.md to reflect the true state of CUT-01, CUT-04, CUT-05:

1. **CUT-01**: Change `- [ ] **CUT-01**:` to `- [x] **CUT-01**:` — ContextForge was stopped in Phase 11 (containers preserved for rollback per 11-02-SUMMARY). The work is done; only the checkbox was missed.

2. **CUT-04**: Change `- [ ] **CUT-04**:` to `- [x] **CUT-04**:` and update the text to: "All active backends respond to tool calls through Sentinel with durable env wiring (6 of 7; exa deferred to v1.2+ pending EXA_API_KEY)"

3. **CUT-05**: Leave as `- [ ] **CUT-05**:` for now — the rollback test will be done in Plan 02. After Plan 02 completes, the executor will update this checkbox.

4. In the Traceability table:
   - Change CUT-01 status from "Pending" to "Done"
   - Change CUT-04 status from "Pending" to "Done"
   - CUT-05 stays "Pending" until Plan 02 completes
  </action>
  <verify>
    - `grep 'CUT-01' /home/lwb3/sentinel-gateway/.planning/REQUIREMENTS.md` shows `[x]` and status "Done"
    - `grep 'CUT-04' /home/lwb3/sentinel-gateway/.planning/REQUIREMENTS.md` shows `[x]`, "6 of 7", "exa deferred", and status "Done"
    - `grep 'CUT-05' /home/lwb3/sentinel-gateway/.planning/REQUIREMENTS.md` shows `[ ]` (still pending)
  </verify>
  <done>
    - CUT-01 checkbox reflects actual completion from Phase 11
    - CUT-04 text accurately describes 6/7 backends with exa deferral rationale
    - CUT-05 remains unchecked until rollback test executes
  </done>
</task>

</tasks>

<verification>
- FIRECRAWL_API_KEY appears in add-mcp.sh env block (not just inherited)
- health_listen = "127.0.0.1:9201" is in sentinel.toml
- sentinel-docker.toml does not exist on disk
- ~/.claude.json has sentinel-gateway only under /home/lwb3 scope
- REQUIREMENTS.md shows CUT-01 [x], CUT-04 [x] with correct text, CUT-05 [ ]
</verification>

<success_criteria>
All config, wiring, and documentation gaps from the v1.1 milestone audit are closed except CUT-05 (rollback test), which requires runtime execution in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/15-cutover-gap-closure/15-01-SUMMARY.md`
</output>
