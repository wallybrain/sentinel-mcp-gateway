---
phase: 10-pre-cutover-preparation
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified: []
autonomous: false
requirements: [PREP-05]

must_haves:
  truths:
    - "Sentinel gateway container is running with status 'healthy'"
    - "Sentinel health endpoint returns 200 on port 9201"
    - "Sentinel MCP transport is reachable on temporary port 9202"
    - "ContextForge is still running and responding on port 9200 (no collision)"
    - "mcp-n8n and mcp-sqlite sidecars are healthy and reachable from Sentinel over sentinelnet"
  artifacts: []
  key_links:
    - from: "sentinel-gateway container"
      to: "mcp-n8n container"
      via: "HTTP over sentinelnet Docker network"
      pattern: "http://mcp-n8n:3000"
    - from: "sentinel-gateway container"
      to: "mcp-sqlite container"
      via: "HTTP over sentinelnet Docker network"
      pattern: "http://mcp-sqlite:3000"
    - from: "sentinel-gateway container"
      to: "sentinel-postgres container"
      via: "TCP over sentinelnet Docker network"
      pattern: "postgres://sentinel.*@postgres:5432"
---

<objective>
Build images, start all Sentinel containers alongside running ContextForge, and verify health of the entire stack.

Purpose: Prove the full Sentinel stack (gateway + postgres + sidecars) runs healthy without interfering with the live ContextForge gateway. This is the final gate before Phase 11 cutover.

Output: Running containers verified via health endpoints and DNS resolution. No file changes -- this plan is purely operational.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-pre-cutover-preparation/10-RESEARCH.md
@.planning/phases/10-pre-cutover-preparation/10-01-SUMMARY.md
@docker-compose.yml
@sentinel.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stop old sidecar containers and start Sentinel stack</name>
  <files></files>
  <action>
  This task involves Docker operations -- all commands need `dangerouslyDisableSandbox: true`.

  1. **Verify ContextForge is still running** on port 9200:
     ```bash
     curl -sf http://127.0.0.1:9200/health | head -c 200
     ```
     Must return a response (any format). If it fails, STOP -- ContextForge is already down, which changes the plan.

  2. **Stop old sidecar containers** from the mcp-servers compose project. These will be replaced by Sentinel-managed ones:
     ```bash
     docker compose -f /home/lwb3/mcp-servers/docker-compose.yml stop n8n-mcp sqlite-mcp
     ```
     Use `stop` not `down` -- this preserves the containers for rollback if needed.

  3. **Build and start Sentinel stack** from the sentinel-gateway directory:
     ```bash
     cd /home/lwb3/sentinel-gateway
     docker compose up -d --build
     ```
     This starts: gateway, postgres, mcp-n8n, mcp-sqlite on sentinelnet.

  4. **Wait for containers to become healthy** (up to 60s):
     ```bash
     docker compose ps
     ```
     All 4 services should show status `healthy` or `running`. The gateway depends on postgres being healthy first, so it may take 15-20s.

  5. **If mcp-n8n or mcp-sqlite fail to start**, check logs:
     ```bash
     docker compose logs mcp-n8n --tail 20
     docker compose logs mcp-sqlite --tail 20
     ```
     Common issues: build context path wrong (absolute path must exist), npm ci failure (network or lockfile), N8N_API_KEY not set.
  </action>
  <verify>
  - `docker compose ps` shows all 4 services (gateway, postgres, mcp-n8n, mcp-sqlite) running
  - `docker inspect sentinel-gateway --format '{{.State.Health.Status}}'` returns `healthy`
  - `docker inspect mcp-n8n --format '{{.State.Health.Status}}'` returns `healthy`
  - `docker inspect mcp-sqlite --format '{{.State.Health.Status}}'` returns `healthy`
  </verify>
  <done>All 4 Sentinel containers are running and healthy. Old mcp-servers sidecar containers are stopped.</done>
</task>

<task type="auto">
  <name>Task 2: Verify health endpoints and network connectivity</name>
  <files></files>
  <action>
  All commands need `dangerouslyDisableSandbox: true`.

  1. **Verify Sentinel health endpoint** (port 9201):
     ```bash
     curl -sf http://127.0.0.1:9201/health | jq .
     ```
     Must return JSON with health status. This is Sentinel's response, not ContextForge's.

  2. **Verify Sentinel MCP transport** (temporary port 9202):
     ```bash
     curl -sf http://127.0.0.1:9202/health
     ```
     The MCP transport listener also serves health on its port. Must return 200.

  3. **Verify ContextForge is still alive** (port 9200):
     ```bash
     curl -sf http://127.0.0.1:9200/health | head -c 200
     ```
     Must still respond. If this fails, there is a port collision (which should be impossible given our 9202 mapping).

  4. **Verify DNS resolution** from inside the gateway container:
     ```bash
     docker exec sentinel-gateway nslookup mcp-n8n 2>/dev/null || docker exec sentinel-gateway getent hosts mcp-n8n
     docker exec sentinel-gateway nslookup mcp-sqlite 2>/dev/null || docker exec sentinel-gateway getent hosts mcp-sqlite
     ```
     Both must resolve to an IP address on sentinelnet. If `nslookup` is not available (slim image), use `getent hosts`.

  5. **Verify sidecar health from inside gateway** (proves network connectivity):
     ```bash
     docker exec sentinel-gateway curl -sf http://mcp-n8n:3000/health
     docker exec sentinel-gateway curl -sf http://mcp-sqlite:3000/health
     ```
     Both must return 200. If curl is not in the gateway image, use:
     ```bash
     docker exec mcp-n8n wget -qO- http://mcp-n8n:3000/health
     ```
     Or test from any container on sentinelnet.

  6. **Verify Sentinel metrics endpoint**:
     ```bash
     curl -sf http://127.0.0.1:9201/metrics | head -20
     ```
     Must return Prometheus text format lines.
  </action>
  <verify>
  - `curl -sf http://127.0.0.1:9201/health` returns 200 with JSON body
  - `curl -sf http://127.0.0.1:9202/health` returns 200
  - `curl -sf http://127.0.0.1:9200/health` returns 200 (ContextForge still alive)
  - DNS resolution for mcp-n8n and mcp-sqlite works from inside gateway container
  - HTTP health check to mcp-n8n:3000 and mcp-sqlite:3000 succeeds from gateway container
  </verify>
  <done>Sentinel health (9201), MCP transport (9202), and metrics all respond. ContextForge still alive on 9200. Gateway can reach both sidecars by hostname over sentinelnet.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Sentinel stack running alongside ContextForge</name>
  <files></files>
  <action>
  Human verification checkpoint. Full Sentinel stack (gateway + postgres + mcp-n8n + mcp-sqlite) is running on Docker alongside ContextForge. The gateway listens on temporary port 9202 for MCP traffic and 9201 for health/metrics. Sidecars are reachable from gateway over sentinelnet Docker network.

  Steps for the user to verify:
  1. Run `docker ps` -- see sentinel-gateway, sentinel-postgres, mcp-n8n, mcp-sqlite all with status "(healthy)"
  2. Run `curl http://127.0.0.1:9201/health` -- Sentinel health JSON
  3. Run `curl http://127.0.0.1:9200/health` -- ContextForge health (still alive)
  4. Run `curl http://127.0.0.1:9202/health` -- Sentinel MCP port (temporary)
  5. Confirm no Claude Code MCP tools are broken (run any MCP tool to verify ContextForge still works)

  Resume signal: Type "approved" if all checks pass, or describe any issues.
  </action>
  <verify>User confirms all 5 verification steps pass.</verify>
  <done>User has approved that Sentinel runs healthy alongside ContextForge with no port collision and no disruption to existing MCP tools.</done>
</task>

</tasks>

<verification>
1. `docker compose ps` -- 4 services, all healthy
2. `curl -sf http://127.0.0.1:9201/health` -- Sentinel health returns 200
3. `curl -sf http://127.0.0.1:9202/health` -- Sentinel MCP returns 200
4. `curl -sf http://127.0.0.1:9200/health` -- ContextForge still alive
5. Gateway can resolve and reach mcp-n8n:3000 and mcp-sqlite:3000 by hostname
6. `curl -sf http://127.0.0.1:9201/metrics | head -5` -- Prometheus metrics available
</verification>

<success_criteria>
- All 4 Sentinel containers running and healthy
- Sentinel health endpoint (9201) returns 200
- Sentinel MCP transport (9202) returns 200
- ContextForge (9200) still responds (no collision)
- Gateway can reach sidecars by hostname over sentinelnet
- User confirms stack is running correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10-pre-cutover-preparation/10-02-SUMMARY.md`
</output>
