---
phase: 10-pre-cutover-preparation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-compose.yml
  - .env.example
  - .env
  - sidecars/Dockerfile.n8n
  - sidecars/Dockerfile.sqlite
autonomous: true
requirements: [PREP-01, PREP-02, PREP-03, PREP-04]

must_haves:
  truths:
    - "Port references agree across sentinel.toml, Dockerfile, and docker-compose.yml -- both 9200 (MCP) and 9201 (health) are exposed and mapped"
    - "Sidecar service definitions (mcp-n8n, mcp-sqlite) exist in Sentinel's docker-compose.yml with correct build contexts and Dockerfiles"
    - "Docker network sentinelnet is defined in docker-compose.yml and all services that need to communicate share it"
    - "Production .env file exists with JWT_SECRET_KEY, POSTGRES_PASSWORD, and N8N_API_KEY -- and is not committed to git"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Rust build with both ports exposed"
      contains: "EXPOSE 9200"
    - path: "docker-compose.yml"
      provides: "Full service stack: gateway, postgres, mcp-n8n, mcp-sqlite with networking"
      contains: "sentinelnet"
    - path: "sidecars/Dockerfile.n8n"
      provides: "Node 20-alpine build for mcp-n8n HTTP transport"
    - path: "sidecars/Dockerfile.sqlite"
      provides: "Node 20-alpine build for mcp-sqlite HTTP transport with native deps"
    - path: ".env"
      provides: "Production secrets for all services"
    - path: ".env.example"
      provides: "Template showing required env vars with placeholder values"
      contains: "N8N_API_KEY"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "gateway service build context"
      pattern: "build: \\."
    - from: "docker-compose.yml"
      to: "sidecars/Dockerfile.n8n"
      via: "mcp-n8n service dockerfile reference"
      pattern: "dockerfile.*sidecars/Dockerfile.n8n"
    - from: "docker-compose.yml"
      to: "sidecars/Dockerfile.sqlite"
      via: "mcp-sqlite service dockerfile reference"
      pattern: "dockerfile.*sidecars/Dockerfile.sqlite"
    - from: "docker-compose.yml"
      to: ".env"
      via: "env var interpolation for secrets"
      pattern: "\\$\\{N8N_API_KEY\\}"
---

<objective>
Fix port config drift, migrate sidecar service definitions into Sentinel's compose, set up Docker networking, and create production .env file.

Purpose: All configuration must be correct before any containers are started. Port drift, missing sidecar definitions, and missing secrets would all cause startup failures or routing errors in Phase 10 Plan 02.

Output: Updated Dockerfile, docker-compose.yml with full service stack and networking, sidecar Dockerfiles copied into repo, production .env file, updated .env.example.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-pre-cutover-preparation/10-RESEARCH.md
@docker-compose.yml
@Dockerfile
@.env.example
@sentinel.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix port config drift and copy sidecar Dockerfiles</name>
  <files>
    Dockerfile
    sidecars/Dockerfile.n8n
    sidecars/Dockerfile.sqlite
  </files>
  <action>
  1. **Dockerfile** -- Add `EXPOSE 9200` line BEFORE the existing `EXPOSE 9201`. The Rust binary listens on two ports: 9200 (MCP transport via `gateway.listen`) and 9201 (health/metrics via `gateway.health_listen`). The healthcheck stays on 9201 (that is correct). Do NOT change anything else in the Dockerfile.

  2. **Create `sidecars/` directory** in the repo root.

  3. **Copy `/home/lwb3/mcp-servers/Dockerfile.http`** to `sidecars/Dockerfile.n8n`. This is a Node 20-alpine image that runs `npm ci` and `node index.js`. Read the source file to get exact contents. Do not modify the Dockerfile content.

  4. **Copy `/home/lwb3/mcp-servers/Dockerfile.sqlite-http`** to `sidecars/Dockerfile.sqlite`. This is a Node 20-alpine image with python3/make/g++ for native SQLite deps. Read the source file to get exact contents. Do not modify the Dockerfile content.
  </action>
  <verify>
  - `grep -c 'EXPOSE 9200' Dockerfile` returns 1
  - `grep -c 'EXPOSE 9201' Dockerfile` returns 1
  - `ls sidecars/Dockerfile.n8n sidecars/Dockerfile.sqlite` both exist
  - `diff sidecars/Dockerfile.n8n /home/lwb3/mcp-servers/Dockerfile.http` shows no differences
  - `diff sidecars/Dockerfile.sqlite /home/lwb3/mcp-servers/Dockerfile.sqlite-http` shows no differences
  </verify>
  <done>Dockerfile exposes both 9200 and 9201. Sidecar Dockerfiles exist in repo at sidecars/ and match their source files exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Add sidecar services, networking, and port mappings to docker-compose.yml</name>
  <files>
    docker-compose.yml
  </files>
  <action>
  Rewrite `docker-compose.yml` to include the full service stack. The final file must have these services:

  **gateway** (update existing):
  - Add port mapping `127.0.0.1:9202:9200` (temporary -- ContextForge occupies host 9200 during Phase 10; Phase 11 changes this to 9200:9200)
  - Keep existing `127.0.0.1:9201:9201` port mapping
  - Add `networks: [sentinelnet]`
  - Keep all existing config (build, container_name, restart, stdin_open, environment, depends_on, healthcheck)

  **postgres** (update existing):
  - Add `networks: [sentinelnet]`
  - Keep all existing config

  **mcp-n8n** (new service):
  ```yaml
  mcp-n8n:
    build:
      context: /home/lwb3/n8n-mcp-server
      dockerfile: /home/lwb3/sentinel-gateway/sidecars/Dockerfile.n8n
    container_name: mcp-n8n
    restart: unless-stopped
    environment:
      - MCP_TRANSPORT=http
      - MCP_PORT=3000
      - N8N_URL=http://n8n:5678
      - N8N_API_KEY=${N8N_API_KEY}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - sentinelnet
      - n8nnet
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
  ```

  **mcp-sqlite** (new service):
  ```yaml
  mcp-sqlite:
    build:
      context: /home/lwb3/sqlite-mcp-server
      dockerfile: /home/lwb3/sentinel-gateway/sidecars/Dockerfile.sqlite
    container_name: mcp-sqlite
    restart: unless-stopped
    environment:
      - MCP_TRANSPORT=http
      - MCP_PORT=3000
      - SQLITE_DB_DIR=/data
    volumes:
      - /home/lwb3/databases:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - sentinelnet
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
  ```

  **Networks section** (new):
  ```yaml
  networks:
    sentinelnet:
      driver: bridge
    n8nnet:
      external: true
      name: n8n-mcp_default
  ```

  Keep existing `volumes: pgdata:` section.

  **Important details:**
  - `mcp-n8n` joins BOTH `sentinelnet` (for gateway communication) AND `n8nnet` (to reach n8n at `http://n8n:5678`)
  - `mcp-sqlite` joins only `sentinelnet`
  - Build contexts use ABSOLUTE paths because the source code lives outside this repo
  - Dockerfile paths also absolute for the same reason
  - The `N8N_API_KEY` env var references `${N8N_API_KEY}` from .env (created in Task 3)
  </action>
  <verify>
  - `docker compose config` runs without errors (proves all env var references resolve and YAML is valid -- requires .env to exist, so run after Task 3)
  - `grep -c 'sentinelnet' docker-compose.yml` returns at least 4 (gateway, postgres, mcp-n8n, mcp-sqlite)
  - `grep '9202:9200' docker-compose.yml` shows temporary MCP port mapping
  - `grep 'n8n-mcp_default' docker-compose.yml` shows external network reference
  - `grep 'N8N_API_KEY' docker-compose.yml` shows env var reference
  </verify>
  <done>docker-compose.yml defines 4 services (gateway, postgres, mcp-n8n, mcp-sqlite) with sentinelnet network, temporary 9202:9200 port mapping, and external n8nnet reference.</done>
</task>

<task type="auto">
  <name>Task 3: Create production .env and update .env.example</name>
  <files>
    .env
    .env.example
  </files>
  <action>
  1. **Generate secrets** using openssl:
     - JWT_SECRET_KEY: `openssl rand -base64 64 | tr -d '\n'`
     - POSTGRES_PASSWORD: `openssl rand -base64 32 | tr -d '\n' | tr '+/' '-_'`

  2. **Extract N8N_API_KEY** from the running mcp-n8n container:
     - `docker inspect mcp-n8n --format '{{range .Config.Env}}{{println .}}{{end}}' | grep N8N_API_KEY | cut -d= -f2-`
     - This is an n8n-issued JWT, not a secret we generate. It must be copied exactly.

  3. **Create `.env`** with:
     ```
     # Sentinel Gateway Production Secrets
     # DO NOT COMMIT -- .gitignore blocks this file

     # JWT secret for token validation (HS256)
     JWT_SECRET_KEY=<generated value>

     # PostgreSQL password (used by Docker Compose)
     POSTGRES_PASSWORD=<generated value>

     # n8n API key (JWT issued by n8n, used by mcp-n8n sidecar)
     N8N_API_KEY=<extracted value>
     ```

  4. **Update `.env.example`** to include N8N_API_KEY:
     ```
     # Sentinel Gateway - Environment Variables
     # Copy to .env and replace with real values

     # JWT secret key for token validation
     JWT_SECRET_KEY=change-me-in-production

     # PostgreSQL password (used by Docker Compose to create the database)
     POSTGRES_PASSWORD=change-me-in-production

     # n8n API key (JWT issued by n8n, copied from n8n dashboard)
     N8N_API_KEY=change-me-copy-from-n8n
     ```

  5. **Verify .env is gitignored**: `grep '\.env' .gitignore` should show it is listed. If not, add `.env` to `.gitignore`.

  6. **Verify .env is NOT staged**: `git status .env` should show it as untracked or ignored.
  </action>
  <verify>
  - `.env` file exists and contains JWT_SECRET_KEY, POSTGRES_PASSWORD, and N8N_API_KEY with real values (not placeholders)
  - `.env.example` contains N8N_API_KEY with placeholder value
  - `git status --porcelain .env` shows `??` (untracked) or nothing (ignored), NOT `A` (staged)
  - `docker compose config` in the sentinel-gateway directory resolves all `${VAR}` references without errors
  </verify>
  <done>.env exists with generated JWT_SECRET_KEY, generated POSTGRES_PASSWORD, and extracted N8N_API_KEY. File is not committed. .env.example updated with N8N_API_KEY placeholder.</done>
</task>

</tasks>

<verification>
1. `grep 'EXPOSE 9200' Dockerfile && grep 'EXPOSE 9201' Dockerfile` -- both ports documented
2. `ls sidecars/Dockerfile.n8n sidecars/Dockerfile.sqlite` -- sidecar build files exist
3. `docker compose config 2>&1 | head -5` -- YAML parses, env vars resolve (no `variable is not set` warnings)
4. `grep -c 'sentinelnet' docker-compose.yml` -- network referenced by all 4 services
5. `git status .env` -- not staged or committed
6. `test -f .env && echo OK` -- production secrets exist
</verification>

<success_criteria>
- Dockerfile exposes both 9200 and 9201
- docker-compose.yml defines gateway, postgres, mcp-n8n, mcp-sqlite with sentinelnet network
- Gateway maps 127.0.0.1:9202:9200 (temporary) and 127.0.0.1:9201:9201
- mcp-n8n joins both sentinelnet and n8nnet (external: n8n-mcp_default)
- .env contains three real secrets, is gitignored, and is not staged
- .env.example documents all three variables with placeholders
- `docker compose config` succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-pre-cutover-preparation/10-01-SUMMARY.md`
</output>
